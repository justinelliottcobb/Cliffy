# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Core Philosophy

Cliffy is a **WASM-first reactive framework** built on **classical FRP semantics** from Conal Elliott's work, with **geometric algebra** as its mathematical foundation.

### The Cliffy Principle

> **"What the developer writes should be simple and familiar. What happens underneath should be mathematically elegant."**

```typescript
// What developers write (familiar API):
const count = behavior(0);
count.subscribe(n => console.log('Count:', n));
count.update(n => n + 1);

// What actually happens (hidden from users):
// - Value stored as GA3 multivector in Rust/WASM
// - Updates are geometric transformations
// - Reactivity flows through algebraic composition
```

### Classical FRP (Not React Hooks)

Cliffy follows Conal Elliott's original FRP semantics:

- **`Behavior<T>`** = `Time → T` — A continuous, time-varying value
- **`Event<T>`** = `[(Time, T)]` — Discrete occurrences over time

This is fundamentally different from React's "hooks" approach:

| Concept | React Hooks | Cliffy FRP |
|---------|-------------|------------|
| State | `useState` returns value + setter | `Behavior` is a continuous signal |
| Effects | `useEffect` with dependency arrays | Automatic propagation via `subscribe`/`map` |
| Derived | `useMemo` with manual deps | `behavior.map()` - automatic |
| Combined | Manual with multiple hooks | `combine(a, b, f)` - declarative |

**Never implement React-style hooks in Cliffy. The reactive graph handles everything.**

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│  @cliffy/core (npm package)                             │
│  TypeScript thin wrapper - type-safe, familiar API      │
│  cliffy-typescript/src/index.ts                         │
└────────────────────────┬────────────────────────────────┘
                         │ imports
┌────────────────────────▼────────────────────────────────┐
│  cliffy-wasm (wasm-bindgen)                             │
│  WASM bindings: Behavior, Event, combinators            │
│  cliffy-wasm/src/lib.rs                                 │
└────────────────────────┬────────────────────────────────┘
                         │ uses
┌────────────────────────▼────────────────────────────────┐
│  cliffy-core (Rust library)                             │
│  FRP primitives backed by geometric algebra             │
│  Behavior<T>, Event<T>, combinators                     │
│  cliffy-core/src/                                       │
└────────────────────────┬────────────────────────────────┘
                         │ depends on
┌────────────────────────▼────────────────────────────────┐
│  amari-core (external)                                  │
│  Geometric Algebra: Multivector<P, Q, R>                │
│  GA3 = Multivector<3, 0, 0> = Cl(3,0)                   │
└─────────────────────────────────────────────────────────┘
```

### Layer Responsibilities

| Layer | Responsibility | Knows About GA? |
|-------|----------------|-----------------|
| `@cliffy/core` | Type-safe TS API, nice DX | No |
| `cliffy-wasm` | JS↔WASM bridge, JsValue handling | No |
| `cliffy-core` | FRP semantics, reactive graph | Yes (internal) |
| `amari-core` | Pure geometric algebra math | Yes (it IS GA) |

**Critical**: Geometric algebra is an *implementation detail*. Users never see `GA3`, `Multivector`, or any GA types. They see `Behavior<number>`, `Event<MouseEvent>`, etc.

## Project Structure

```
cliffy/
├── Cargo.toml                 # Rust workspace
├── package.json               # NPM workspace
├── CLAUDE.md                  # This file
│
├── cliffy-core/               # Rust FRP library (29 tests)
│   ├── Cargo.toml
│   └── src/
│       ├── lib.rs             # Public API
│       ├── behavior.rs        # Behavior<T> implementation
│       ├── event.rs           # Event<T> implementation
│       ├── combinators.rs     # when, combine, if_else, etc.
│       └── geometric.rs       # IntoGeometric/FromGeometric traits
│
├── cliffy-wasm/               # WASM bindings
│   ├── Cargo.toml
│   └── src/
│       └── lib.rs             # wasm_bindgen exports
│
├── cliffy-typescript/         # TypeScript wrapper (@cliffy/core)
│   ├── package.json
│   ├── tsconfig.json
│   ├── src/
│   │   └── index.ts           # Thin wrapper around WASM
│   └── pkg/                   # Generated by wasm-pack
│
├── examples/
│   └── counter-101/           # Minimal working example
│
└── archive/                   # Old crates (reference only)
    ├── cliffy-alive/          # Living UI (to be rebuilt on new foundation)
    ├── cliffy-protocols/
    ├── cliffy-dom/
    └── ...
```

## Build Commands

```bash
# Full build (Rust → WASM → TypeScript)
npm run build

# Or step by step:
cargo build -p cliffy-core           # Build Rust core
cargo build -p cliffy-wasm           # Build WASM crate
npm run build:wasm                   # wasm-pack build
npm run build:ts                     # TypeScript compile

# Run tests
cargo test --workspace               # 39 Rust tests
```

## Development Server (Hot Reload)

```bash
# Start dev server with hot reload (recommended)
npm run dev                          # Runs counter-101 example

# Run any example with hot reload
npm run example counter-101
npm run example -- --list            # List all examples

# What happens:
# 1. cargo-watch monitors cliffy-core and cliffy-wasm
# 2. On Rust change → rebuilds WASM automatically
# 3. Vite detects WASM change → reloads browser
```

The dev server runs two processes concurrently:
- **[wasm]** `cargo watch` - Rebuilds WASM on Rust changes
- **[vite]** Vite dev server - Serves example with HMR

## API Reference

### Behavior<T> — Time-Varying Values

```typescript
import { behavior, combine, ifElse, when } from '@cliffy/core';

// Create
const count = behavior(0);
const name = behavior('Alice');

// Read
count.sample();  // 0

// Update
count.set(10);
count.update(n => n + 1);

// Subscribe
const unsub = count.subscribe(n => console.log(n));
unsub.unsubscribe();

// Derive
const doubled = count.map(n => n * 2);
const fullName = combine(firstName, lastName, (f, l) => `${f} ${l}`);

// Conditional
const message = when(showMessage, () => "Hello!");  // null when false
const theme = ifElse(isDark, () => "dark", () => "light");
```

### Event<T> — Discrete Occurrences

```typescript
import { event } from '@cliffy/core';

// Create
const clicks = event<MouseEvent>();

// Emit
clicks.emit(mouseEvent);

// Subscribe
clicks.subscribe(e => console.log(e.clientX));

// Transform
const positions = clicks.map(e => ({ x: e.clientX, y: e.clientY }));
const leftClicks = clicks.filter(e => e.button === 0);

// Merge streams
const allInputs = mouseEvents.merge(touchEvents);

// Fold into Behavior
const clickCount = clicks.fold(0, (acc, _) => acc + 1);
```

## Development Guidelines

### DO: Foundation First

When adding features, work bottom-up:

1. **cliffy-core** (Rust): Implement the reactive primitive
2. **cliffy-wasm**: Expose via wasm_bindgen
3. **@cliffy/core** (TS): Add type-safe wrapper

### DON'T: Skip Layers

Never add functionality directly to TypeScript that should be in Rust:
- ❌ Complex state logic in TypeScript
- ❌ Custom reactive primitives in JS
- ✅ All reactivity in Rust, exposed via WASM

### DO: Hide Geometric Algebra

Users should never see:
- `GA3`, `Multivector`, `IntoGeometric`, `FromGeometric`
- Blade indices, basis vectors, geometric products

Users should see:
- `Behavior<number>`, `Event<string>`, `combine()`, `when()`

### DON'T: React Patterns

Never implement:
- ❌ `useState`, `useEffect`, `useMemo` style hooks
- ❌ Component lifecycle methods
- ❌ Virtual DOM diffing
- ❌ JSX as runtime (JSX should compile to behavior graphs)

### DO: Classical FRP Patterns

Always implement:
- ✅ Pure `Behavior<T>` and `Event<T>` types
- ✅ Combinators: `map`, `combine`, `filter`, `fold`
- ✅ Declarative composition over imperative updates

## The January 2026 Rebuild

### Why It Happened

The project had accumulated complexity that obscured the core vision:
- Multiple incomplete crates with circular dependencies
- GA concepts leaking into user-facing APIs
- React-like patterns creeping in
- No clear "simplest example" that worked end-to-end

### What Changed

| Before | After |
|--------|-------|
| 8+ Rust crates, many broken | 2 crates: `cliffy-core`, `cliffy-wasm` |
| Complex TypeScript with JSX runtime | Thin wrapper around WASM |
| GA types in user code | GA completely hidden |
| No working examples | `counter-101` works end-to-end |

### Archived Crates

The following crates are archived in `archive/` for reference:
- `cliffy-alive` — Living UI (to be rebuilt on new foundation)
- `cliffy-protocols` — CRDT/consensus protocols
- `cliffy-dom` — DOM manipulation layer
- `cliffy-components` — Component library
- `cliffy-frp` — Old FRP implementation
- `cliffy-gpu` — GPU acceleration

These may be restored once the foundation is solid.

## Future Roadmap

### Phase 1: Foundation (DONE)
- [x] cliffy-core with Behavior, Event, combinators
- [x] cliffy-wasm with clean JS bindings
- [x] @cliffy/core TypeScript wrapper
- [x] counter-101 example

### Phase 2: DOM Integration
- [ ] DOM helpers: `bindText()`, `bindAttr()`, `bindClass()`
- [ ] Event helpers: `fromDOMEvent()`, `fromInput()`
- [ ] Declarative DOM updates (no virtual DOM)

### Phase 3: Component Model
- [ ] Behavior-based components
- [ ] Compositional UI patterns
- [ ] Build-time optimization

### Phase 4: Living UI Revival
- [ ] Rebuild cliffy-alive on new foundation
- [ ] Cellular automata with GA state
- [ ] Evolutionary UI adaptation

## Testing

```bash
# Rust tests (29 unit + 10 doc tests)
cargo test -p cliffy-core

# Full workspace
cargo test --workspace

# TypeScript type checking
cd cliffy-typescript && npx tsc --noEmit
```

## Key Files

| File | Purpose |
|------|---------|
| `cliffy-core/src/behavior.rs` | Core `Behavior<T>` implementation |
| `cliffy-core/src/event.rs` | Core `Event<T>` implementation |
| `cliffy-core/src/combinators.rs` | `when`, `combine`, `if_else`, etc. |
| `cliffy-core/src/geometric.rs` | GA conversion traits (internal) |
| `cliffy-wasm/src/lib.rs` | All WASM exports |
| `cliffy-typescript/src/index.ts` | TypeScript API |
| `examples/counter-101/src/main.ts` | Reference example |

## Remember

> **Simple API. Elegant internals. Classical FRP. No React patterns.**

When in doubt, ask: "Would Conal Elliott approve?"
